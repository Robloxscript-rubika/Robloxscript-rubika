-- Fly Script کاملاً بازنویسی شده
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- تنظیمات
local flySpeed = 50
local flying = false
local flyConnection

-- GUI ساده
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "FlyGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = game.CoreGui

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 150, 0, 80)
Frame.Position = UDim2.new(0.5, -75, 0.1, 0)
Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Frame.BorderSizePixel = 0
Frame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 10)
UICorner.Parent = Frame

local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(1, -20, 0, 40)
ToggleButton.Position = UDim2.new(0, 10, 0, 10)
ToggleButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
ToggleButton.Text = "OFF"
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.Font = Enum.Font.GothamBold
ToggleButton.TextSize = 18
ToggleButton.BorderSizePixel = 0
ToggleButton.Parent = Frame

local ButtonCorner = Instance.new("UICorner")
ButtonCorner.CornerRadius = UDim.new(0, 8)
ButtonCorner.Parent = ToggleButton

local SpeedLabel = Instance.new("TextLabel")
SpeedLabel.Size = UDim2.new(1, -20, 0, 20)
SpeedLabel.Position = UDim2.new(0, 10, 1, -25)
SpeedLabel.BackgroundTransparency = 1
SpeedLabel.Text = "Speed: 50"
SpeedLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
SpeedLabel.Font = Enum.Font.Gotham
SpeedLabel.TextSize = 12
SpeedLabel.Parent = Frame

-- Drag System
local dragging
local dragInput
local dragStart
local startPos

local function update(input)
    local delta = input.Position - dragStart
    Frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

Frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = Frame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

Frame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)

-- Fly System (کاملاً جدید)
local function startFly()
    local char = LocalPlayer.Character
    if not char then return end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if not hrp or not humanoid then return end
    
    -- حذف BodyGyro و BodyVelocity قدیمی
    for _, v in pairs(hrp:GetChildren()) do
        if v:IsA("BodyGyro") or v:IsA("BodyVelocity") then
            v:Destroy()
        end
    end
    
    local bg = Instance.new("BodyGyro")
    bg.P = 9e4
    bg.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
    bg.Parent = hrp
    
    local bv = Instance.new("BodyVelocity")
    bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)
    bv.Parent = hrp
    
    -- سیستم جدید: RenderStepped برای آپدیت سریع‌تر
    flyConnection = RunService.RenderStepped:Connect(function()
        if not flying or not hrp or not hrp.Parent or not bg or not bg.Parent or not bv or not bv.Parent then
            if flyConnection then flyConnection:Disconnect() end
            return
        end
        
        -- گرفتن دوربین و Humanoid (هر فریم)
        local cam = workspace.CurrentCamera
        local hum = char:FindFirstChildOfClass("Humanoid")
        
        if not cam or not hum then return end
        
        -- محاسبه جهت حرکت
        local movement = Vector3.new(0, 0, 0)
        
        -- PC Controls
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then
            movement = movement + cam.CFrame.LookVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then
            movement = movement - cam.CFrame.LookVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then
            movement = movement - cam.CFrame.RightVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then
            movement = movement + cam.CFrame.RightVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
            movement = movement + Vector3.new(0, 1, 0)
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then
            movement = movement - Vector3.new(0, 1, 0)
        end
        
        -- Mobile Controls (بهینه شده)
        local moveDir = hum.MoveDirection
        if moveDir and moveDir.Magnitude > 0 then
            -- تبدیل MoveDirection به جهت دوربین
            local camCF = cam.CFrame
            local forward = camCF.LookVector
            local right = camCF.RightVector
            
            -- محاسبه دقیق
            movement = movement + (forward * -moveDir.Z) + (right * moveDir.X)
        end
        
        -- اعمال حرکت
        if movement.Magnitude > 0 then
            movement = movement.Unit
            bv.Velocity = movement * flySpeed
        else
            bv.Velocity = Vector3.new(0, 0, 0)
        end
        
        -- چرخش کاراکتر با دوربین
        bg.CFrame = cam.CFrame
    end)
end

local function stopFly()
    flying = false
    
    if flyConnection then
        flyConnection:Disconnect()
        flyConnection = nil
    end
    
    local char = LocalPlayer.Character
    if char then
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if hrp then
            for _, v in pairs(hrp:GetChildren()) do
                if v:IsA("BodyGyro") or v:IsA("BodyVelocity") then
                    v:Destroy()
                end
            end
        end
    end
end

-- Toggle Button
ToggleButton.MouseButton1Click:Connect(function()
    flying = not flying
    
    if flying then
        ToggleButton.BackgroundColor3 = Color3.fromRGB(50, 255, 50)
        ToggleButton.Text = "ON"
        startFly()
    else
        ToggleButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        ToggleButton.Text = "OFF"
        stopFly()
    end
end)

-- Speed Controls
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == Enum.KeyCode.Equals or input.KeyCode == Enum.KeyCode.Plus then
        flySpeed = math.min(flySpeed + 10, 500)
        SpeedLabel.Text = "Speed: " .. flySpeed
    elseif input.KeyCode == Enum.KeyCode.Minus then
        flySpeed = math.max(flySpeed - 10, 10)
        SpeedLabel.Text = "Speed: " .. flySpeed
    end
end)

-- Respawn Handler
LocalPlayer.CharacterAdded:Connect(function(char)
    task.wait(0.5)
    if flying then
        stopFly()
        flying = true
        startFly()
    end
end)

print("✅ Advanced Fly System Loaded!")
